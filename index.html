<!--
AI Chat â€” LLMãªã—ãƒ•ãƒ«å®Œæˆç‰ˆ v4 (All Features)
Includes:
- N-gram Markov (1..3) with smoothing
- Weighting for user vs AI training
- Manual and auto training controls
- Export / Import conversations + model
- Electron packaging support files (package.json, main.js included separately)
- UI improvements (animations, fireworks on 'success')

Usage:
- Save this file as index.html and open in a browser for standalone web use.
- To build a desktop app (recommended to avoid CORS issues), use the provided package.json and main.js with Electron.
-->
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJQAAACUCAMAAABC4vDmAAAAZlBMVEX///8AAADx8fFQUFD29vbt7e01NTXm5ub8/Pzc3Nzh4eG3t7ewsLBBQUHY2Nj5+fnJyckpKSlqamq9vb2lpaWfn5+GhoYvLy8cHBwWFhZ5eXljY2NWVlaSkpJvb2/Q0NBJSUkNDQ3JMh3rAAAKB0lEQVR4nO1cW5uqOgwVBBEEAbmI3JT//yePkpaGNoXqsGfOg3nZ+1MGFm2ycq273Ve+8pWvfOUr/1eJbfclthP/NRImcZKX7dUa5dCUJ/+vAe2ce30drJlU+9z+U0jFw6JkKIO/gmQXKQkJYP3NamWRFtKoXtnvQ7LrmR5Fj7Zp2scBf1g6v4wpQMt0K093dwTgeEnYii8uv7uF2Y0/OO3Px/l3Tjdp/8P7RUyJ2CLKzOyOf73/vbU68We2upWw+Sa2z221g3MSFnmRZ3ff/VeYzhxTftRec+SLVWd1K5hjiPrunzC+z55xPS9eNi2nIkO3/JefCN+ZtZ3ItKisod8YFtuXaA2Tm+tBvZRtS1gBu+masa/w/ZNvi+1AweYNyfJV9xmkfV924Sksyrqt0MePrVSeMVS5eJGDXVAU+vZkpXaQXdBirbyaocTNeLfrIqRCPPbaqdsc58ITbbKFjKKWAoBsLzCVtOY5p4m5wg1A9eOdGj1p3tHu9HqdiSdHlP8YkwtvqFUFuxyELi3HUwlfrPtPQQFLHzTfOqFYpXRVW3jwk/40ci6XVjwRNDDUBtGBza5//ARRkOVjYHkjF/zci2VqzNjajX6mVs65jLgSPIgo1y6nqM9KE70dzCUAKq0+IlF7lkld1AtClNbkb0TmmfaOa+J080xKUeE7gly/FwCDklpvL9VJ9qwSIQTIpzTv+g1ngFd576/c2pJlZsJ2J1xsdKJv4S2YIrDIe7Tg4WVqoIqBH4GjgY5+9tNk93pnYsPWv+NtJtq1qiZzWNiCnu0ISD0d9CWQnu61vA3eOzLHdB74I8uRefYyqCnijWhl8sTml5pI1YWvjU32zNWFZ1IKKJYcHOjVt1EM8xRNgQgUwLTw4HB9KXh5TrNSjWbn5DLRg3wyxAudGaYjC0JuYmc0oMgwNGgtVfYEIUEsa0gKPG9DfuwNUJgpsuv0/5taifFHB3UxKpYyBRyw2SigEg2ok4A06lsoYCluyBvt82GUz7PQcObBNaDkpQ9QwMACYq8UH7VzS3VH1VtNI1/iww3mrlIBdSdAeZ14fiN0yNeFNu7eGBQQTDpXTBNQmSjmVSccwxxFtmBVnfjGfKU8CI+kgEABBclNjz4QbufWKWEVCjeGkGt2ML6FSSGL1QGk266BiutBaA7lYz2U6zTMhMD6mnVKd4Bk5DhVAeVjUHEuIFlXDUWfEX3Vo3IY85RHaRQBCqodYA13iS01gbqD6CItHO6RDRgdopxG/lgB5U2gAjXusmo6SnI6saJVZu77LuTu6UHFhWDHg9DmtKM1JcCqBf8YRAlg1kq4rQHV3LHNzYLVqyZ6S6S9NoinPHhZxaQ1oCqRXl1GuvFRjaOlwzsnnGUjBqnfHaxU+VwDapLH5EBwHa+mcxUXMb9JjA4Bgupnl0FVIfL0Ti6M7KaJOoOGX3EwyLFCzZIugpJrUdgHVpqK+4nbx3XdywCfqzqqgHKF6hCshI1Mk8vH3E3vV5PYt0HdDIxMQ6a8fKRqMHmhOSh9F/R4GgQsOgvjGdEapwMoteylgLLHDxZJBrclKzVw2ImW2Er9CMCrPvKnoF5kSsTibAd1BUImkPA9/gEoJRgehcXKy7m7DZaqvJQG1OIrjqCGBHF8o5ISUG26zAtwkfLHCijHEJQ1q/jfOvl1mVotO5uStgcAhRy6OainIZaoLyPvFDywWkz+QNNbGhQyofgNUE8/jVhL0izGLYtRlUv+5Y4rRsgX62gKir3HeVKtvXQZLFW/VMI9AvvLLlnc8vwZKFH/l0ExrVpU9Yy8RnT+rRaswBSUUBbW8ZZBsYLcYs00rsilQn2Oqjy+AUoxDgVUST5wLjmtVXEnokzrmYt8AMqmQUG2thwWs36VetG5Eaj2yWAISiFcBRQY8nU5UWY7RaynHPQvg4oMQe3GkkK14pWZ0yIcUozLTZuBghxoJf+7W7RaveTYVZuDKnRrMBMeY5PgXVRuGk5azrNZAIC4RQdKF1lKwlWavnCm8ZpVD7mtGoNaTQA9zuA96SiPCconL0Tmhios263Uzp0yILoVdAyRaskTCLjMiSsAP9Opp/hT3NjQOayLOqIVrvvGGK8RKHgH+u1n4qEN6mhn6aNyhpiilLsNBqBGFaX703OZTRulIV2vwdUyaCm4Igu9VYagIOBIDRqrUlOUCvpfgsm0dnfIP0b3xhAUVABWMpqXsHYesn3KyHbzNnMqEKZFzOpv66BgUwxa3BBVRTvUXBl0xTldedEUFLy5gfEBpz/5LEajy7cTDet8mUNi1TL4FCVGNCg2fWigUvD2oyLhldCN06EFtYacEW5vBgp2rzWopo9LyucrsFu5UG8kamDWUE93B1DoNUhQYHsmVUZ7dDMHDiAOh+mpqZITHrHNIQwACtEPCQro/GawezAgsxekiSOWVOoGCUiHGSvXJqCYRpm0RwFUiyNUvIdokMxHH0s+0AgUsxGT6RIAJfUscTBMdBh7mciQsWhBMcdh1Nx25zrFxEG+5/rSzBB3+JSblOugEqarRh1bsL6bsqgxmrxLM+F6K+pVARQKAhVQfGjbIEB4ibL0XHBLYRKyw7cOih8CuBiOggGjkyN/6iQE7azdZhlUzOtWkelgCfd9lNjzIeqCziK5vqGtmYHyuNmsJXxCnEUFRM0VzXyZmGekV8qfzFZVXL1E+v17yR1U66DZOZSFKbWEdhcnl8nLp+9MqEGG8dAn+OHeOtAOy0atmQgHuax4i2OK906ysJnHhSjH9ujNRZN81XwELbBkeffYFpDC8O75pQS5HbmTnEiQ6AGmJWHTJcu1LFmw23ko6cl80utQfHBgi239G28zG2smNh4rU/POpKoQn03Sms484lz+RimLw1h3uD6K4NMTpowjjaZ2pPCU5EPoTx/y5EcHoNibRSbD3GjWJdKMNRcfKKkqAduPaHUH8WlNTTbNC4SGEYFeeEmvWjkfgGbk9cwDhLDSrzKRyfUq3ScheJDsoq9SHEHneu0F5jIZeapJRDEz6ap6o7BOxibnsAThtbm6Wl6HstBlMoQLm20OmyeoBHbJgklljrYfonAPJaGksAXd5rTTU2dwpFm1dVmEp7Ar+1lcHK2UvFiGoPQRP5diVi8kZPU0NB9C2fKIOWZrQvLVU4iMMwxnl41h9YMelOk6bbh5HBZurUmyzNJnZqHK9OEm4nd9JBYsbeuMl64WuPU4EfD2B2uZuP49y4uiCJPzix2c6SS0zrtMmdTPnZ6x2BMxkCdCRCa1GUOZiDexWCQXao/nfgoebr/7Ewo2CnLbMPHghwrc+wm1SQyCn43Fwe0h6wA/6RDN+NbkzN/WkslDSXNZOa35rwQfGJUl1RRAfkECDazHJ8nddmLne8lvD9f6/qeQRvHDsmHqdWjLPPnf/HqQw37P6P8C6Ctf+cpXvvIVVf4D/Ah3TlTDJjIAAAAASUVORK5CYII=" />
<title>Chatgtp</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=" />
<style>
:root{--bg:#071018;--panel:#071425;--muted:#9aa4b2;--accent:#10a37f;--accent-2:#0a84ff}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
body{background:linear-gradient(180deg,#020409 0%, var(--bg) 100%);color:#e6eef6;}
.app{display:grid;grid-template-columns:320px 1fr;gap:18px;width:100%;height:100vh;padding:18px}
.sidebar{background:linear-gradient(180deg,#051018,#071425);padding:16px;border-radius:12px;display:flex;flex-direction:column}
.brand{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700}
.brand h1{font-size:15px;margin:0}
.btn{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:10px;color:inherit;cursor:pointer}
.new-chat{margin-bottom:8px}
.search{margin-bottom:10px;padding:8px;border-radius:8px;border:none;background:#08121a;color:inherit}
.hist-list{flex:1;overflow:auto;padding-right:6px}
.hist-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px;cursor:pointer}
.hist-item .title{font-size:13px}
.small{font-size:12px;color:var(--muted)}
.panel{display:flex;flex-direction:column;border-radius:12px;background:linear-gradient(180deg,#071425,#071a28);padding:12px}
.header{display:flex;justify-content:space-between;align-items:center;padding:6px 12px;border-bottom:1px solid rgba(255,255,255,0.03)}
.header .left{display:flex;gap:12px;align-items:center}
.chat{flex:1;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:12px}
.msg{max-width:78%;padding:12px 14px;border-radius:12px;line-height:1.6}
.msg.user{margin-left:auto;background:linear-gradient(90deg,var(--accent),#0bd59b);color:#012;border-bottom-right-radius:6px}
.msg.ai{background:linear-gradient(180deg,#071425,#09202b);border:1px solid rgba(255,255,255,0.02)}
.controls{display:flex;gap:8px;padding:12px;border-top:1px solid rgba(255,255,255,0.02);align-items:center}
.textarea{flex:1;padding:12px;border-radius:18px;border:1px solid rgba(255,255,255,0.03);min-height:56px;resize:none;background:transparent;color:inherit}
.send{background:var(--accent);border:none;padding:10px 14px;border-radius:12px;color:#012;cursor:pointer}
.kv{font-size:13px;color:var(--muted)}
.settings{position:fixed;right:20px;top:20px;width:420px;background:linear-gradient(180deg,#061216,#08161b);padding:14px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6);display:none;z-index:80}
.row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
select,input[type=range]{width:100%}
.small-muted{font-size:12px;color:var(--muted)}
.footer-note{font-size:12px;color:var(--muted);margin-top:8px}
.fireworks{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none}
@media(max-width:900px){.app{grid-template-columns:72px 1fr;padding:10px}.sidebar{padding:8px}.brand h1{display:none}.hist-item .title{font-size:12px}}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand"><div class="logo">AI</div><h1>chatgtp</h1></div>
    <button class="btn new-chat" id="newChatBtn">ï¼‹ æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ</button>
    <input class="search" id="searchHist" placeholder="å±¥æ­´ã‚’æ¤œç´¢..." />
    <div class="hist-list" id="histList"></div>
    <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
      <button class="btn" id="exportBtn">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <button class="btn" id="importBtn">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
    </div>
    <div style="margin-top:10px" class="small">å®Œå…¨ãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ä½œã—ã¾ã™ã€‚å¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã«ã¯æ¥ç¶šã—ã¾ã›ã‚“ã€‚</div>
  </aside>

  <main class="panel">
    <div class="header">
      <div class="left"><strong id="chatTitle">æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ</strong><div class="kv" id="vocabCount">èªå½™: 0</div></div>
      <div>
        <button class="btn" id="themeToggle">ğŸŒ“</button>
        <button class="btn" id="openSettings">âš™ï¸</button>
      </div>
    </div>

    <div class="chat" id="chatWindow"></div>

    <div class="controls">
      <textarea id="input" class="textarea" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ï¼ˆShift+Enterã§æ”¹è¡Œï¼‰"></textarea>
      <button class="send" id="sendBtn">é€ä¿¡</button>
    </div>
  </main>
</div>

<div class="settings" id="settingsPanel">
  <h3>è¨­å®šï¼ˆå­¦ç¿’ãƒ»ç”Ÿæˆï¼‰</h3>
  <label class="kv">äººæ ¼ï¼ˆAIã®å£èª¿ï¼‰</label>
  <textarea id="persona" placeholder="ä¾‹ï¼šä¸å¯§ã§ã€åˆ†ã‹ã‚Šã‚„ã™ãèª¬æ˜ã™ã‚‹"></textarea>
  <div class="row"><label class="kv">è‡ªå‹•å­¦ç¿’</label><select id="autoLearn"><option value="1">æœ‰åŠ¹</option><option value="0">ç„¡åŠ¹</option></select></div>
  <div class="row"><label class="kv">N-gram ã‚µã‚¤ã‚º</label><select id="ngram"><option value="1">1 (unigram)</option><option value="2">2 (bigram)</option><option value="3">3 (trigram)</option></select></div>
  <div class="row"><label class="kv">ãƒ¦ãƒ¼ã‚¶ãƒ¼å­¦ç¿’é‡ã¿</label><input type="range" id="userWeight" min="0" max="5" step="0.5" value="1" /><span id="userWeightVal" class="kv">1</span></div>
  <div class="row"><label class="kv">AIå­¦ç¿’é‡ã¿</label><input type="range" id="aiWeight" min="0" max="5" step="0.5" value="1" /><span id="aiWeightVal" class="kv">1</span></div>
  <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
    <button class="btn" id="saveSettings">ä¿å­˜</button>
    <button class="btn" id="closeSettings">é–‰ã˜ã‚‹</button>
  </div>
  <hr style="margin:10px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)" />
  <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
    <button class="btn" id="saveModelBtn">å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ä¿å­˜</button>
    <button class="btn" id="loadModelBtn">å­¦ç¿’ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿</button>
    <button class="btn" id="clearModelBtn">å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
  </div>
  <div class="footer-note">å­¦ç¿’ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚</div>
</div>

<canvas id="fireworks" class="fireworks"></canvas>

<script>
/* ====================================================
   N-gram Markov engine with weighting and smoothing
==================================================== */
class NGramMarkov{
  constructor(n=2){ this.n = n; this.map = new Map(); this.startTokens = []; }

  _key(seq){ return seq.join('\u0001'); }

  train(text, weight=1){
    if(!text) return;
    const tokens = this._tokenize(text);
    if(tokens.length < 1) return;
    // add to start tokens (for sentence starts)
    this.startTokens.push(tokens[0]);

    // build n-grams
    for(let i=0;i<=tokens.length - this.n;i++){
      const seq = tokens.slice(i, i+this.n);
      const key = this._key(seq.slice(0, -1)); // context
      const next = seq[seq.length-1];
      if(!this.map.has(key)) this.map.set(key, {});
      const obj = this.map.get(key);
      obj[next] = (obj[next] || 0) + weight;
    }
  }

  _tokenize(text){
    // simple tokenizer: split by spaces and punctuation, but keep Japanese characters as-is
    // split on whitespace and common punctuation
    return String(text).replace(/[ã€‚ï¼ï¼Ÿ!?]/g,' ã€‚ ').replace(/[\n\r]+/g,' ').split(/\s+/).filter(Boolean);
  }

  generate(seed=null, max=50){
    if(this.map.size === 0) return null;
    let context = null;
    if(seed){ const s = seed.split(/\s+/).slice(- (this.n-1)); context = s; }
    if(!context){ const rnd = this.startTokens[Math.floor(Math.random()*this.startTokens.length)]; context = [rnd]; }
    // ensure context length n-1
    while(context.length < this.n-1) context.unshift('');

    const out = [...context];
    for(let i=0;i<max;i++){
      const key = this._key(out.slice(- (this.n-1)));
      const choices = this.map.get(key);
      if(!choices){ break; }
      // weighted random
      const entries = Object.entries(choices);
      const total = entries.reduce((s,[k,v])=>s+v,0);
      let r = Math.random()*total; let pick = entries[entries.length-1][0];
      for(const [tok,wt] of entries){ if(r < wt){ pick = tok; break; } r -= wt; }
      out.push(pick);
    }
    // join into string
    let s = out.filter(Boolean).join(' ');
    if(!/[ã€‚ï¼ï¼Ÿ.!?]$/.test(s)) s += 'ã€‚';
    return s;
  }

  size(){ return this.map.size; }

  export(){
    const entries = [];
    for(const [k,obj] of this.map.entries()){ entries.push([k, obj]); }
    return JSON.stringify({ n: this.n, map: entries, startTokens: this.startTokens });
  }

  import(json){ const o = JSON.parse(json); this.n = o.n || this.n; this.map = new Map(o.map); this.startTokens = o.startTokens || []; }

  clear(){ this.map = new Map(); this.startTokens = []; }
}

/* ====================================================
   App state
==================================================== */
let model = new NGramMarkov(2);
let history = JSON.parse(localStorage.getItem('ai_chat_history')||'[]');
let currentConversation = { id: Date.now(), title: 'æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ', messages: [] };
let personaText = localStorage.getItem('ai_persona') || '';
let autoLearn = localStorage.getItem('ai_auto_learn') !== '0';
let ngramSize = parseInt(localStorage.getItem('ai_ngram')||'2',10);
let userWeight = parseFloat(localStorage.getItem('ai_user_weight')||'1');
let aiWeight = parseFloat(localStorage.getItem('ai_ai_weight')||'1');

function saveSettingsLocal(){ localStorage.setItem('ai_persona', personaText); localStorage.setItem('ai_auto_learn', autoLearn? '1':'0'); localStorage.setItem('ai_ngram', String(ngramSize)); localStorage.setItem('ai_user_weight', String(userWeight)); localStorage.setItem('ai_ai_weight', String(aiWeight)); }

/* ====================================================
   UI helpers
==================================================== */
const chatWindow = document.getElementById('chatWindow');
const inputEl = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const histList = document.getElementById('histList');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');

function renderHistory(){ histList.innerHTML=''; history.slice().reverse().forEach((c)=>{
  const d = document.createElement('div'); d.className='hist-item'; d.innerHTML = `<div class="title">${escapeHtml(c.title || 'Untitled')}</div><div class="small">${new Date(c.id).toLocaleString()}</div>`;
  d.onclick = ()=>{ loadConversation(c.id); };
  histList.appendChild(d);
}); }

function saveCurrentToHistory(){ currentConversation.title = currentConversation.messages.find(m=>m.role==='user')?.text?.slice(0,40) || currentConversation.title; const idx = history.findIndex(h=>h.id===currentConversation.id); if(idx>=0) history[idx] = currentConversation; else history.push(currentConversation); localStorage.setItem('ai_chat_history', JSON.stringify(history)); renderHistory(); }

function loadConversation(id){ const c = history.find(h=>h.id===id); if(!c) return; currentConversation = JSON.parse(JSON.stringify(c)); renderConversation(); }
function newConversation(){ currentConversation = { id: Date.now(), title: 'æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ', messages: [] }; renderConversation(); }

function renderConversation(){ chatWindow.innerHTML=''; document.getElementById('chatTitle').innerText = currentConversation.title; for(const m of currentConversation.messages){ const el = document.createElement('div'); el.className = 'msg ' + (m.role==='user'?'user':'ai'); el.innerText = m.text; chatWindow.appendChild(el); } chatWindow.scrollTop = chatWindow.scrollHeight; }

function addMessageToConversation(role,text){ currentConversation.messages.push({ role, text, time: Date.now() }); const el = document.createElement('div'); el.className = 'msg ' + (role==='user'?'user':'ai'); el.innerText = text; chatWindow.appendChild(el); chatWindow.scrollTop = chatWindow.scrollHeight; }

function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ====================================================
   Model operations: train with weights, save/load/export/import
==================================================== */
function trainText(text, role){
  if(!text) return;
  const weight = (role==='user')? userWeight : aiWeight;
  // split into sentences and train each sentence
  const parts = String(text).split(/[ã€‚ï¼ï¼Ÿ.!?]+/).filter(Boolean);
  for(const p of parts){ model.train(p.trim(), weight); }
}

function saveModel(){ try{ const data = model.export(); localStorage.setItem('ngram_model_v1', data); alert('å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ'); }catch(e){ alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'); } }
function loadModel(){ try{ const raw = localStorage.getItem('ngram_model_v1'); if(!raw) return alert('å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); model.import(raw); document.getElementById('vocabCount').innerText = 'èªå½™: ' + model.size(); alert('å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ'); }catch(e){ alert('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); } }
function clearModel(){ if(confirm('å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')){ model.clear(); document.getElementById('vocabCount').innerText = 'èªå½™: 0'; alert('å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã—ãŸ'); } }

/* ====================================================
   Reply generation pipeline
==================================================== */
const fallbackReplies = ['ãªã‚‹ã»ã©ã€èˆˆå‘³æ·±ã„ã§ã™ã­ã€‚','ã‚‚ã†å°‘ã—è©³ã—ãè©±ã—ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹ï¼Ÿ','ãã†ãªã‚“ã§ã™ã­ã€‚','ãŸã—ã‹ã«ãã†ã„ã†è€ƒãˆæ–¹ã‚‚ã‚ã‚Šã¾ã™ã€‚','ãã‚Œã¯é¢ç™½ã„ã§ã™ã­ã€‚','ç¶šã‘ã¦ãã ã•ã„ã€‚','ãã‚Œã§ã©ã†æ€ã„ã¾ã—ãŸã‹ï¼Ÿ','ã„ã„ã§ã™ã­ã€‚'];

function generateReply(userText){
  // persona training (optional)
  if(personaText && autoLearn){ trainText(personaText, 'ai'); }
  // train on recent conversation if autoLearn
  if(autoLearn){ for(const m of currentConversation.messages){ trainText(m.text, m.role); } }
  const seed = (userText||'').split(/\s+/)[0] || (personaText||'').split(/\s+/)[0] || null;
  const gen = model.generate(seed, 60);
  if(gen) return gen;
  return fallbackReplies[Math.floor(Math.random()*fallbackReplies.length)];
}

/* ====================================================
   Send flow
==================================================== */
sendBtn.addEventListener('click', async ()=>{
  const text = inputEl.value.trim(); if(!text) return; inputEl.value='';
  addMessageToConversation('user', text);
  if(autoLearn) trainText(text, 'user');
  saveCurrentToHistory();
  // typing indicator
  const typing = document.createElement('div'); typing.className='msg ai'; typing.innerText='ç”Ÿæˆä¸­â€¦'; chatWindow.appendChild(typing); chatWindow.scrollTop = chatWindow.scrollHeight;
  try{
    await new Promise(r=>setTimeout(r, 250 + Math.random()*600));
    const reply = generateReply(text);
    typing.remove(); addMessageToConversation('ai', reply);
    if(autoLearn) trainText(reply, 'ai');
    document.getElementById('vocabCount').innerText = 'èªå½™: ' + model.size();
    saveCurrentToHistory();
    // small celebration when model grows
    if(model.size() % 50 === 0) fireworkBurst();
  }catch(e){ typing.remove(); addMessageToConversation('ai','ã‚¨ãƒ©ãƒ¼: '+e.message); }
});

inputEl.addEventListener('keydown',(e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); } });

/* ====================================================
   Settings UI wiring
==================================================== */
document.getElementById('openSettings').addEventListener('click', ()=>{ document.getElementById('settingsPanel').style.display='block'; document.getElementById('persona').value = personaText; document.getElementById('autoLearn').value = autoLearn? '1':'0'; document.getElementById('ngram').value = ngramSize; document.getElementById('userWeight').value = userWeight; document.getElementById('aiWeight').value = aiWeight; document.getElementById('userWeightVal').innerText = userWeight; document.getElementById('aiWeightVal').innerText = aiWeight; });
document.getElementById('closeSettings').addEventListener('click', ()=>{ document.getElementById('settingsPanel').style.display='none'; });

document.getElementById('saveSettings').addEventListener('click', ()=>{
  personaText = document.getElementById('persona').value || '';
  autoLearn = document.getElementById('autoLearn').value === '1';
  ngramSize = parseInt(document.getElementById('ngram').value,10);
  userWeight = parseFloat(document.getElementById('userWeight').value);
  aiWeight = parseFloat(document.getElementById('aiWeight').value);
  model.n = ngramSize; // set model size (note: existing model data may be inconsistent)
  saveSettingsLocal();
  alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ'); document.getElementById('settingsPanel').style.display='none';
});

document.getElementById('userWeight').addEventListener('input', (e)=>{ document.getElementById('userWeightVal').innerText = e.target.value; });
document.getElementById('aiWeight').addEventListener('input', (e)=>{ document.getElementById('aiWeightVal').innerText = e.target.value; });

/* ====================================================
   Model save/load/clear
==================================================== */
document.getElementById('saveModelBtn').addEventListener('click', saveModel);
document.getElementById('loadModelBtn').addEventListener('click', loadModel);
document.getElementById('clearModelBtn').addEventListener('click', clearModel);

/* ====================================================
   Export / Import conversations & model
==================================================== */
exportBtn.addEventListener('click', ()=>{
  const data = { history, model: model.export(), persona: personaText };
  const b = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'ai_chat_export.json'; a.click();
});

importBtn.addEventListener('click', ()=>{
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange = ()=>{
    const f = inp.files[0]; const r = new FileReader(); r.onload = ()=>{
      try{
        const o = JSON.parse(r.result);
        if(o.model) model.import(o.model);
        if(o.persona) { personaText = o.persona; localStorage.setItem('ai_persona', personaText); }
        if(Array.isArray(o.history)) { history = o.history; localStorage.setItem('ai_chat_history', JSON.stringify(history)); }
        alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†'); renderHistory();
      }catch(e){ alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    }; r.readAsText(f);
  }; inp.click();
});

/* ====================================================
   Fireworks (visual celebration)
==================================================== */
const canvas = document.getElementById('fireworks');
const ctx = canvas.getContext('2d');
function resizeCanvas(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resizeCanvas); resizeCanvas();

let particles = [];
function fireworkBurst(){ const centerX = Math.random()*canvas.width; const centerY = Math.random()*canvas.height*0.6 + canvas.height*0.1; const count = 30 + Math.floor(Math.random()*40);
  for(let i=0;i<count;i++){ particles.push({ x:centerX, y:centerY, vx:(Math.random()-0.5)*6, vy:(Math.random()-0.8)*6, life:60+Math.random()*40, color: `hsl(${Math.random()*360}, 80%, 60%)` }); }
}
function tick(){ ctx.clearRect(0,0,canvas.width, canvas.height); for(let i=particles.length-1;i>=0;i--){ const p = particles[i]; p.x += p.vx; p.y += p.vy; p.vy += 0.08; p.life -= 1; ctx.globalAlpha = Math.max(0, p.life/100); ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x,p.y,Math.max(1, p.life/10),0,Math.PI*2); ctx.fill(); if(p.life<=0) particles.splice(i,1); } requestAnimationFrame(tick); }
requestAnimationFrame(tick);

/* ====================================================
   Init: load saved model & settings
==================================================== */
try{ const raw = localStorage.getItem('ngram_model_v1'); if(raw){ model.import(raw); } }catch(e){}
try{ personaText = localStorage.getItem('ai_persona') || personaText; autoLearn = localStorage.getItem('ai_auto_learn') !== '0'; ngramSize = parseInt(localStorage.getItem('ai_ngram')||'2',10); userWeight = parseFloat(localStorage.getItem('ai_user_weight')||'1'); aiWeight = parseFloat(localStorage.getItem('ai_ai_weight')||'1'); model.n = ngramSize; }catch(e){}

renderHistory(); renderConversation(); document.getElementById('vocabCount').innerText = 'èªå½™: ' + model.size();
// shortcut
window.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); inputEl.focus(); } });

</script>
</body>
</html>
